(window.webpackJsonp=window.webpackJsonp||[]).push([[149],{589:function(s,a,t){"use strict";t.r(a);var e=t(27),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"山特ups配合nut实现断电安全关机"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#山特ups配合nut实现断电安全关机"}},[s._v("#")]),s._v(" 山特ups配合nut实现断电安全关机")]),s._v(" "),t("h2",{attrs:{id:"背景"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[s._v("#")]),s._v(" 背景")]),s._v(" "),t("p",[s._v("搞了7*24小时服务器之后经历了两次突然断电，每次重启磁盘检查都要卡很久，夏天一到用电量骤升，市电断电和跳闸的几率都增加了。万一多来几次突然断电，磁盘阵列可能要挂了，更关键的是数据无价啊，ups还是少不了。")]),s._v(" "),t("h2",{attrs:{id:"选择"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#选择"}},[s._v("#")]),s._v(" 选择")]),s._v(" "),t("p",[s._v("因为不是成品nas系统，想实现自动关机得依靠linux上已有的软件。而我对"),t("code",[s._v("apcupsd")]),s._v("这款软件有所耳闻，所以第一选择就去看了新款的"),t("code",[s._v("apc bk650m2-ch")]),s._v("，快下单了才得知新款不支持apcupsd，然后就听网友的建议看了山特的"),t("code",[s._v("box600")]),s._v("和"),t("code",[s._v("box850")]),s._v("，山特这个型号有两排插座，一排防雷+不断电，一排是防雷，还省了了插排钱，自带的usb通讯端口可以通过"),t("code",[s._v("nut")]),s._v("软件进行管理，实现自动关机以及自定义脚本执行等功能，虽然电池容量小了点，但是能省就省吧，最后下单了box600。")]),s._v(" "),t("h2",{attrs:{id:"nut安装及配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#nut安装及配置"}},[s._v("#")]),s._v(" nut安装及配置")]),s._v(" "),t("p",[s._v("ups机器本身没什么可讲的，把附带的rj45接ups，usb线接主机，再把主机电源插在ups的不断电插口上，接着给ups通电即可。主要介绍下nut的使用和配置。")]),s._v(" "),t("h3",{attrs:{id:"安装nut"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装nut"}},[s._v("#")]),s._v(" 安装nut")]),s._v(" "),t("p",[t("code",[s._v("apt install nut")])]),s._v(" "),t("h3",{attrs:{id:"配置驱动"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置驱动"}},[s._v("#")]),s._v(" 配置驱动")]),s._v(" "),t("p",[s._v("首先可以用"),t("code",[s._v("lsusb")]),s._v("命令查看是否接入了ups，能看到ups即可")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://storyxc.com/images/blog/image-20220524232436626.png",alt:"image-20220524232436626"}})]),s._v(" "),t("p",[s._v("然后编辑ups配置文件"),t("code",[s._v("vim /etc/nut/ups.conf")]),s._v(",增加配置如下")]),s._v(" "),t("div",{staticClass:"language-conf line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('maxretry = 3\n[santak]\n        driver = usbhid-ups\n        port = auto\n        desc = "my ups"\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("santak是ups的设备名，可以自定义，后续有些命令这个设备名还会用到")]),s._v(" "),t("h3",{attrs:{id:"配置nut服务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置nut服务"}},[s._v("#")]),s._v(" 配置nut服务")]),s._v(" "),t("h4",{attrs:{id:"新建ups用户"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#新建ups用户"}},[s._v("#")]),s._v(" 新建ups用户")]),s._v(" "),t("p",[t("code",[s._v("vim /etc/nut/upsd.users")]),s._v("新增配置")]),s._v(" "),t("div",{staticClass:"language-conf line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("[ups]\n        password = xxx\n        upsmon master\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[t("code",[s._v("ups")]),s._v("为用户名，"),t("code",[s._v("xxx")]),s._v("为密码，"),t("code",[s._v("upsmon master")]),s._v("为运行模式")]),s._v(" "),t("h4",{attrs:{id:"配置权限"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置权限"}},[s._v("#")]),s._v(" 配置权限")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chown")]),s._v(" root:nut /etc/nut/upsd.conf /etc/nut/upsd.users\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" 0640 /etc/nut/upsd.conf /etc/nut/upsd.users\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h4",{attrs:{id:"启动nut服务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#启动nut服务"}},[s._v("#")]),s._v(" 启动nut服务")]),s._v(" "),t("p",[t("code",[s._v("vim /etc/nut/nut.conf")]),s._v("修改模式为单机")]),s._v(" "),t("div",{staticClass:"language-conf line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("MODE=standalone\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("启动upsd服务")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("/sbin/upsd\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h4",{attrs:{id:"查看ups信息"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看ups信息"}},[s._v("#")]),s._v(" 查看ups信息")]),s._v(" "),t("p",[s._v("查看全部")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("/bin/upsc santak@localhost "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这里的santak就是上面的设备名")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("查看某个信息在后面接信息类别就行，例如查看电量")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("/bin/upsc santak@127.0.0.1 battery.charge\n\nInit SSL without certificate database\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h2",{attrs:{id:"设置自动关机"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#设置自动关机"}},[s._v("#")]),s._v(" 设置自动关机")]),s._v(" "),t("p",[s._v("nut服务会在UPS发送"),t("code",[s._v("LOWBATT")]),s._v("时通知机器关机，触发时机默认为ups电量剩余"),t("code",[s._v("20%")]),s._v("。我们需要添加upsmon配置"),t("code",[s._v("vim /etc/nut/upsmon.conf")])]),s._v(" "),t("p",[s._v("在"),t("code",[s._v("MONITOR")]),s._v("监视器部分添加配置")]),s._v(" "),t("div",{staticClass:"language-conf line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("MONITOR santak@localhost 1 ups xxx master\n\n# MONITOR 设备名@ip 1 用户名 密码 节点\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("授权")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chown")]),s._v(" root:nut /etc/nut/upsmon.conf\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" 0640 /etc/nut/upsmon.conf\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("启动upsmon")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("/sbin/upsmon\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"自定义脚本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#自定义脚本"}},[s._v("#")]),s._v(" 自定义脚本")]),s._v(" "),t("p",[s._v("实际上配置完上面的内容已经可以实现断电时安全关机了，但喜欢折腾的还可以自定义触发事件的脚本")]),s._v(" "),t("h3",{attrs:{id:"修改upsmon配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#修改upsmon配置"}},[s._v("#")]),s._v(" 修改upsmon配置")]),s._v(" "),t("p",[t("code",[s._v("vim /etc/nut/upsmon.conf")]),s._v("添加内容")]),s._v(" "),t("div",{staticClass:"language-conf line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("NOTIFYCMD /sbin/upssched\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("这个配置的作用是发生事件是运行"),t("code",[s._v("upssched")]),s._v("程序")]),s._v(" "),t("p",[s._v("设置触发条件,三个动作分别是记录日志+通知所有用户发生了事件+执行notifycmd，也就是"),t("code",[s._v("/sbin/upssched")])]),s._v(" "),t("div",{staticClass:"language-conf line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("NOTIFYFLAG ONBATT SYSLOG+WALL+EXEC\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"配置upssched"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置upssched"}},[s._v("#")]),s._v(" 配置upssched")]),s._v(" "),t("p",[t("code",[s._v("vim /etc/nut/upssched.conf")]),s._v("编辑内容")]),s._v(" "),t("div",{staticClass:"language-conf line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("CMDSCRIPT /usr/local/bin/upssched\nPIPEFN /usr/local/bin/nut/upssched/upssched.pipe\nLOCKFN /usr/local/bin/nut/upssched/upssched.lock\nAT ONBATT * START-TIMER power-off 10\nAT ONLINE * CANCEL-TIMER power-off\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("这段配置通过CMDSCRIPT指定了发生事件时需要执行的脚本，这个脚本可以根据需求自定义，在断电时(ONBATT/电池供电)会启动一个10秒的timer，之后会执行power-off事件，这里涉及的文件nut用户都需要配置权限")]),s._v(" "),t("h3",{attrs:{id:"编写脚本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#编写脚本"}},[s._v("#")]),s._v(" 编写脚本")]),s._v(" "),t("p",[s._v("这个可以自定义，例如发邮件等操作，这里展示最基本的脚本格式，例如power-off事件发生时，将"),t("code",[s._v("断电了")]),s._v("信息写入指定文件，还可以调用ups的指令"),t("code",[s._v("/sbin/upsmon -c fsd")]),s._v('执行立刻关机操作 (FSD = "Forced Shutdown")')]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#! /bin/sh")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("\n  power-off"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'===============断电了==============='")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /usr/local/bin/r.txt\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#/sbin/upsmon -c fsd #立即通知关机")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  *"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    logger -t upssched "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Unrecognized command: '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v('"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("esac")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])])])}),[],!1,null,null,null);a.default=n.exports}}]);