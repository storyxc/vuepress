(window.webpackJsonp=window.webpackJsonp||[]).push([[132],{572:function(s,a,t){"use strict";t.r(a);var e=t(27),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"docker-jenkins-gitee自动化部署vue项目"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#docker-jenkins-gitee自动化部署vue项目"}},[s._v("#")]),s._v(" docker+jenkins+gitee自动化部署vue项目")]),s._v(" "),t("p",[s._v("之前"),t("a",{attrs:{href:"https://blog.storyxc.com",target:"_blank",rel:"noopener noreferrer"}},[s._v("个人博客"),t("OutboundLink")],1),s._v("一直用的travisCI部署在github page上，但是偶尔会抽风无法访问。之前一直偷懒没部署jenkins，手动部署到云服务器又比较麻烦，打包上传很浪费时间，这次就直接动手一步到位，在自己服务器上部署下jekins。")]),s._v(" "),t("h2",{attrs:{id:"docker启动jenkins"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#docker启动jenkins"}},[s._v("#")]),s._v(" docker启动jenkins")]),s._v(" "),t("ul",[t("li",[s._v("启动容器")])]),s._v(" "),t("p",[s._v("最开始用的jenkins中文社区的镜像发现有个很恶心的问题，jenkins版本比较低而且安装了NodeJS插件后在全局工具配置中配置NodeJS安装环境时无法选择版本，所以还是官方镜像比较靠谱。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 拉取官方镜像")]),s._v("\ndocker pull jenkins/jenkins:lts\nlts: Pulling from jenkins/jenkins\n4c25b3090c26: Pull complete\n750d566fdd60: Pull complete\n2718cc36ca02: Pull complete\n5678b027ee14: Pull complete\nc839cd2df78d: Pull complete\n50861a5addda: Pull complete\nff2b028e5cf5: Pull complete\nee710b58f452: Pull complete\n2625c929bb0e: Pull complete\n6a6bf9181c04: Pull complete\nbee5e6792ac4: Pull complete\n6cc5edd2133e: Pull complete\nc07b16426ded: Pull complete\ne9ac42647ae3: Pull complete\nfa925738a490: Pull complete\n4a08c3886279: Pull complete\n2d43fec22b7e: Pull complete\nDigest: sha256:a942c30fc3bcf269a1c32ba27eb4a470148eff9aba086911320031a3c3943e6c\nStatus: Downloaded newer image "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" jenkins/jenkins:lts\ndocker.io/jenkins/jenkins:lts\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动jenkins")]),s._v("\ndocker run --name jenkins -dp "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8099")]),s._v(":8080 -v /story/dist:/story/dist -v ~/jenkins_data:/var/jenkins_home -u root  -e "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TZ")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Asia/Shanghai"')]),s._v(" -v /etc/localtime:/etc/localtime:ro jenkins/jenkins:lts\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 参数说明 --name 指定容器名为jenkins -d 后台启动 -p 将容器的8080端口映射到宿主机的8099端口")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -v 挂载宿主机目录 宿主机和容器的目录会同步 -u 指定用户为root 这里是必须的 不然后续操作文件系统会报无权限")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 挂载时区的目录是因为镜像中的linux系统默认时区非北京时间，会导致时间显示不正确")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br")])]),t("ul",[t("li",[s._v("启动后直接访问本机8099端口：http://localhost:8099/（我这里是本地测试，实际请替换成自己的服务器地址）")])]),s._v(" "),t("h2",{attrs:{id:"apt安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#apt安装"}},[s._v("#")]),s._v(" apt安装")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -fsSL https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tee")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  /usr/share/keyrings/jenkins-keyring.asc "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /dev/null\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" -c "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'echo \"deb [signed-by=/usr/share/keyrings/jenkins-keyring.asc] https://pkg.jenkins.io/debian-stable binary/\" > /etc/apt/sources.list.d/jenkins.list'")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt")]),s._v(" update\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Jenkins requires Java 11 or 17 since Jenkins 2.357 and LTS 2.361.1. ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" openjdk-17-jdk\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" jenkins\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://storyxc.com/images/blog//image-20210914101747191.png",alt:"image-20210914101747191"}})]),s._v(" "),t("ul",[t("li",[s._v("进到容器中查询下密码")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("docker "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -it jenkins /bin/bash\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /var/jenkins_home/secrets/initialAdminPassword\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("或者直接在上面挂载的目录查询但要改一下路径")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" ~/jenkins_data/secrets/initialAdminPassword\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("使用密码登录后直接安装推荐插件即可")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://storyxc.com/images/blog//image-20210914102028448.png",alt:"image-20210914102028448"}})]),s._v(" "),t("ul",[t("li",[s._v("等待安装完成")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://storyxc.com/images/blog//image-20210914102652130.png",alt:"image-20210914102652130"}})]),s._v(" "),t("ul",[t("li",[s._v("新建账户")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://storyxc.com/images/blog//image-20210914102716607.png",alt:"image-20210914102716607"}})]),s._v(" "),t("ul",[t("li",[t("p",[s._v("实例配置")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://storyxc.com/images/blog//image-20210914102906576.png",alt:"image-20210914102906576"}})])]),s._v(" "),t("li",[t("p",[s._v("完成")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://storyxc.com/images/blog//image-20210914102924807.png",alt:""}})])])]),s._v(" "),t("h2",{attrs:{id:"jenkins配置自动部署"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#jenkins配置自动部署"}},[s._v("#")]),s._v(" jenkins配置自动部署")]),s._v(" "),t("h3",{attrs:{id:"安装node和gitee插件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装node和gitee插件"}},[s._v("#")]),s._v(" 安装node和gitee插件")]),s._v(" "),t("p",[s._v("Manage Jenkins ---\x3e Manage Plugins ---\x3e 可选插件分别搜索gitee和nodejs\n"),t("img",{attrs:{src:"https://storyxc.com/images/blog//image-20210914111457469.png",alt:"image-20210914111457469"}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://storyxc.com/images/blog//image-20210914111526455.png",alt:"image-20210914111526455"}})]),s._v(" "),t("p",[s._v("选择install without restart")]),s._v(" "),t("p",[s._v("安装完毕后返回工作台")]),s._v(" "),t("h3",{attrs:{id:"配置node环境"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置node环境"}},[s._v("#")]),s._v(" 配置node环境")]),s._v(" "),t("p",[s._v("Manage Jenkins ---\x3e Global Tool Configuration ---\x3e NodeJS")]),s._v(" "),t("p",[s._v("新增NodeJS取别名后保存即可")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://storyxc.com/images/blog//image-20210914111718160.png",alt:"image-20210914111718160"}})]),s._v(" "),t("h2",{attrs:{id:"新建自动部署任务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#新建自动部署任务"}},[s._v("#")]),s._v(" 新建自动部署任务")]),s._v(" "),t("h3",{attrs:{id:"新建任务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#新建任务"}},[s._v("#")]),s._v(" 新建任务")]),s._v(" "),t("p",[s._v("工作台点击新建Item，输入任务名称后选择freestyle project确定")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://storyxc.com/images/blog//image-20210914111819597.png",alt:"image-20210914111819597"}})]),s._v(" "),t("h3",{attrs:{id:"配置gitee相关内容"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置gitee相关内容"}},[s._v("#")]),s._v(" 配置gitee相关内容")]),s._v(" "),t("h4",{attrs:{id:"源码管理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#源码管理"}},[s._v("#")]),s._v(" 源码管理")]),s._v(" "),t("ul",[t("li",[s._v("添加gitee仓库地址，指定要打包的分支")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://storyxc.com/images/blog//image-20210914112017978.png",alt:"image-20210914112017978"}})]),s._v(" "),t("h4",{attrs:{id:"构建触发器"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#构建触发器"}},[s._v("#")]),s._v(" 构建触发器")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://storyxc.com/images/blog//image-20210914112740392.png",alt:"image-20210914112740392"}})]),s._v(" "),t("ul",[t("li",[s._v("生成webhook密码")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://storyxc.com/images/blog//image-20210914112804397.png",alt:"image-20210914112804397"}})]),s._v(" "),t("ul",[t("li",[t("p",[s._v("去gitee仓库中配置webhook内容")]),s._v(" "),t("p",[s._v("仓库的管理tab页添加webhook")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://storyxc.com/images/blog//image-20210914112946461.png",alt:"image-20210914112946461"}})])])]),s._v(" "),t("p",[s._v("url和webhook密码分别填写后保存")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://storyxc.com/images/blog//image-20210914113229679.png",alt:"image-20210914113229679"}})]),s._v(" "),t("p",[s._v("在这个页面点击测试，如果看到xxx has been accepted即为成功。")]),s._v(" "),t("h4",{attrs:{id:"构建环境"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#构建环境"}},[s._v("#")]),s._v(" 构建环境")]),s._v(" "),t("p",[s._v("选择前面已经配置好的node环境即可")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://storyxc.com/images/blog//image-20210914113502188.png",alt:"image-20210914113502188"}})]),s._v(" "),t("h4",{attrs:{id:"构建"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#构建"}},[s._v("#")]),s._v(" 构建")]),s._v(" "),t("p",[s._v("首先在任务面板中点击立即构建，这样才会生成工作空间")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://storyxc.com/images/blog//image-20210914114129450.png",alt:"image-20210914114129450"}})]),s._v(" "),t("p",[s._v("我这里选择执行shell")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://storyxc.com/images/blog//image-20210914113546293.png",alt:"image-20210914113546293"}})]),s._v(" "),t("p",[s._v("然后就是写个简单的脚本执行打包，替换的工作")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://storyxc.com/images/blog//image-20210914113643970.png",alt:"image-20210914113643970"}})]),s._v(" "),t("p",[t("strong",[s._v("第一步cd进入的目录是当前任务的工作空间，这里要把vuepress替换成自己的任务名称即可")])]),s._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),t("p",[s._v("这里涉及到文件系统操作的内容rm cp等命令需要root用户才能执行，所以在启动docker容器的时候必须使用-u root参数指定root用户，否则打包会失败，操作文件时会提示无权限")])]),s._v(" "),t("p",[s._v("配置完毕保存即可")]),s._v(" "),t("h2",{attrs:{id:"测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#测试"}},[s._v("#")]),s._v(" 测试")]),s._v(" "),t("p",[s._v("点击立即构建或者往gitee仓库推送一次更新即可触发构建任务，然后等待构建完成即可。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://storyxc.com/images/blog//image-20210914114542885.png",alt:"image-20210914114542885"}})]),s._v(" "),t("p",[s._v("如果是第一次执行构建，jenkins还会自动安装解压nodejs。")]),s._v(" "),t("p",[s._v("通过脚本替换完打包好的dist后，通过nginx配置部署静态项目即可。")]),s._v(" "),t("h2",{attrs:{id:"jenkins打包跨平台docker镜像并推送镜像仓库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#jenkins打包跨平台docker镜像并推送镜像仓库"}},[s._v("#")]),s._v(" jenkins打包跨平台docker镜像并推送镜像仓库")]),s._v(" "),t("p",[s._v("这里是用宿主机直接安装的jenkins")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("把jenkins用户添加到docker组中然后重启jenkins："),t("code",[s._v("sudo usermod -aG docker jenkins")])]),s._v(" "),t("blockquote",[t("p",[s._v("getent group "),t("groupname",[s._v(" 查看组中有哪些用户")])],1)])]),s._v(" "),t("li",[t("p",[s._v("shell")])])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/sh")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /var/lib/jenkins/workspace/xxx\nnode -v\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" -v\ndocker -v\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" run build\ndocker buildx "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\ndocker buildx create --use --name jenkinsbuilder\ndocker buildx "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Dockerfile")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Dockerfile "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n// doSomething\nEOF")]),s._v("\n\ndocker login xxx.com --username"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'xxx'")]),s._v(" --password"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'xxx'")]),s._v("\ndocker buildx build --platform linux/amd64,linux/arm64 -t xxx/xxx "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v(" --push\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])])])}),[],!1,null,null,null);a.default=n.exports}}]);